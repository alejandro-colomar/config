#!/bin/bash
set -uo pipefail;
########################################################################
#	Copyright (C) 2020-2021   Alejandro Colomar Andres
#	SPDX-License-Identifier:  GPL-2.0-only
########################################################################

synopsis="sudo ${BASH_SOURCE[0]} [OPTION]...";

usage="\
Usage:  ${synopsis}
Try '${BASH_SOURCE[0]} -h' for more information.";

help="\
SYNOPSIS
	${synopsis}

DESCRIPTION
	Safely remove secrets from </run/secrets/PROJECT/>.

	Root permissions are required to remove files from /run.

OPTIONS
	-h	Print this help and exit.

	-v	Verbose output.

ERRORS
	EX_USAGE
		Invalid or missing arguments or options.

	EX_NOINPUT
		No secrets were found.

	EX_NOPERM
		Not enough permissions.
";

EX_OK=0;
EX_USAGE=64;
EX_NOINPUT=66;
EX_NOPERM=77;

v='';
while getopts 'hv' opt; do
	case ${opt} in
	h)	echo "${help}";
		exit ${EX_OK};
		;;
	v)	v='-v';
		;;
	?)	>&2 echo "${usage}";
		exit ${EX_USAGE};
		;;
	esac;
done;
shift $((${OPTIND} - 1));

if [ $# -ne 0 ]; then
	>&2 echo "${usage}";
	exit ${EX_USAGE};
fi;

! [ -d run/secrets/* ] \
	&&exit ${EX_NOINPUT};

if [ $(id -u) -ne 0 ]; then
	>&2 echo "${usage}";
	exit ${EX_NOPERM};
fi;

project="$(find run/secrets/* -maxdepth 0 | xargs basename)";

find -L "/run/secrets/${project}/" -type f \
|xargs shred -f "${v}" --remove=wipe;
rm -rf "${v}" "/run/secrets/${project}/";

exit ${EX_OK};
